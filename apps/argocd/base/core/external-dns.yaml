apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: external-dns
spec:
  project: cluster
  source:
    repoURL: https://charts.bitnami.com/bitnami
    chart: external-dns
    targetRevision: 6.18.0
    helm:
      releaseName: external-dns
      values: |
        aws:
          apiRetries: 3
          batchChangeSize: 1000
          credentials:
            mountPath: /.aws
          region: us-east-1
          zonesCacheDuration: 0
        azure:
          useManagedIdentityExtension: false
        cloudflare:
          apiKey: <path:kv/data/cloudflare#api-key-64>
          apiToken: <path:kv/data/cloudflare#api-token-64>
          email: <path:kv/data/cloudflare#email-64>
          proxied: false
        clusterDomain: cluster.local
        combineFQDNAnnotation: false
        containerPorts:
          http: 7979
        coredns:
          etcdEndpoints: http://etcd-extdns:2379
          etcdTLS:
            autoGenerated: false
            caFilename: ca.crt
            certFilename: cert.pem
            enabled: false
            keyFilename: key.pem
            mountPath: /etc/coredns/tls/etcd
            secretName: etcd-client-certs
        crd:
          create: true
        designate:
          customCA:
            enabled: false
            filename: designate-ca.pem
            mountPath: /config/designate
        dryRun: false
        forceTxtOwnerId: false
        google:
          batchChangeSize: 1000
          serviceAccountSecretKey: credentials.json
        hetzner:
          secretKey: hetzner_token
        ignoreHostnameAnnotation: false
        image:
          pullPolicy: IfNotPresent
          registry: docker.io
          repository: bitnami/external-dns
          tag: 0.13.4-debian-11-r2
        infoblox:
          noSslVerify: false
          wapiUsername: admin
        interval: 1m
        livenessProbe:
          enabled: true
          failureThreshold: 2
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        logFormat: text
        logLevel: debug
        metrics:
          enabled: false
          googlePodMonitor:
            enabled: false
            endpoint: /metrics
            interval: 60s
          serviceMonitor:
            enabled: false
            honorLabels: false
        ns1:
          minTTL: 10
        oci:
          privateKey: |
            -----BEGIN RSA PRIVATE KEY-----
            -----END RSA PRIVATE KEY-----
        pdns:
          apiPort: "8081"
        podAntiAffinityPreset: soft
        podSecurityContext:
          enabled: true
          fsGroup: 1001
          runAsUser: 1001
        policy: upsert-only
        provider: cloudflare
        publishHostIP: true
        publishInternalServices: true
        rbac:
          apiVersion: v1
          clusterRole: true
          create: true
          pspEnabled: false
        readinessProbe:
          enabled: true
          failureThreshold: 6
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        registry: txt
        textPrefix: k8s-
        replicaCount: 1
        resources:
          limits:
            cpu: 150m
            memory: 256Mi
          requests:
            cpu: 35m
            memory: 50Mi
        rfc2136:
          minTTL: 0s
          port: 53
          rfc3645Enabled: false
          tsigAxfr: true
          tsigKeyname: externaldns-key
          tsigSecretAlg: hmac-sha256
        service:
          enabled: true
          externalTrafficPolicy: Cluster
          ports:
            http: 7979
          sessionAffinity: None
          type: ClusterIP
        serviceAccount:
          automountServiceAccountToken: true
          create: true
        sources:
        - service
        - ingress
        startupProbe:
          enabled: true
          failureThreshold: 6
          initialDelaySeconds: 20
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        triggerLoopOnEvent: false
        useDaemonset: false
        watchReleaseNamespace: false
  destination:
    namespace: networking
    name: in-cluster
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: true
    syncOptions:
    - Validate=false
    - CreateNamespace=true
    - PrunePropagationPolicy=foreground
    - PruneLast=true
    - ApplyOutOfSyncOnly=false
    - Prune=true
    - Relace=True
    retry:
      limit: 5
      backoff:
        duration: 60s
        factor: 2
        maxDuration: 15m
