apiVersion: v1
kind: Secret
metadata:
  name: matrix-media-vars
  annotations:
    avp.kubernetes.io/path: "kv/data/s3"
stringData:
  S3_ENDPOINT: "<endpoint-uri>"
  S3_ACCESS_ID: "<access-key-id>"
  S3_ACCESS_SECRET: "<secret-access-key>"
  S3_BUCKET_NAME: "<path:kv/data/matrix#bucket-name>"
---
apiVersion: v1
kind: Secret
metadata:
  name: matrix-media-config
type: Opaque
stringData:
  config.yaml.tmpl: |
    repo:
      bindAddress: 0.0.0.0
      port: 8000
      logDirectory: logs
      logColors: false
      jsonLogs: false
      logLevel: info
      trustAnyForwardedAddress: true
      useForwardedHost: true
    federation:
      backoffAt: 20
      ignoredHosts:
        - example.org
    database:
      postgres: >-
        postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db-matrix.matrix1.svc.cluster.local:5432/media?sslmode=require
      pool:
        maxConnections: 25
        maxIdleConnections: 5
    homeservers:
      - name: matrix.gruber.dev.br
        csApi: 'http://matrix-matrix-synapse.matrix1.svc.cluster.local:8008'
        backoffAt: 10
        adminApiKind: matrix
    accessTokens:
      maxCacheTimeSeconds: 0
      useLocalAppserviceConfig: false
      appservices:
        - id: Name_of_appservice_for_your_reference
          asToken: Secret_token_for_appservices_to_use
          senderUserId: '@_example_bridge:yourdomain.com'
          userNamespaces:
            - regex: '@_example_bridge_.+:yourdomain.com'
    admins:
      - '@gruber:matrix.gruber.dev.br'
    sharedSecretAuth:
      enabled: true
      token: '${SHARED_SECRET}'
    datastores:
      - type: file
        id: images
        forKinds:
          - thumbnails
        opts:
          path: /data/media
      - type: s3
        id: vultr
        forKinds:
          - thumbnails
          - remote_media
          - local_media
          - archives
        opts:
          tempPath: /data/s3
          endpoint: '${S3_ENDPOINT}'
          accessKeyId: '${S3_ACCESS_ID}'
          accessSecret: '${S3_ACCESS_SECRET}'
          ssl: true
          bucketName: '${S3_BUCKET_NAME}'
    archiving:
      enabled: true
      selfService: false
      targetBytesPerPart: 209715200
    uploads:
      maxBytes: 104857600
      minBytes: 100
      maxPending: 5
      maxAgeSeconds: 1800
      quotas:
        enabled: false
        users:
          - glob: '@*:*'
            maxBytes: 53687063712
            maxPending: 5
    downloads:
      maxBytes: 104857600
      numWorkers: 10
      failureCacheMinutes: 5
      expireAfterDays: 0
      defaultRangeChunkSizeBytes: 10485760
    urlPreviews:
      enabled: true
      maxPageSizeBytes: 10485760
      previewUnsafeCertificates: false
      numWords: 50
      maxLength: 200
      numTitleWords: 30
      maxTitleLength: 150
      filePreviewTypes:
        - image/*
      numWorkers: 10
      disallowedNetworks:
        - 169.254.0.0/16
      allowedNetworks:
        - 0.0.0.0/0
      expireAfterDays: 0
      defaultLanguage: 'en-US,en'
      userAgent: matrix-media-repo
      oEmbed: false
    thumbnails:
      maxSourceBytes: 10485760
      maxPixels: 32000000
      numWorkers: 100
      sizes:
        - width: 32
          height: 32
        - width: 96
          height: 96
        - width: 320
          height: 240
        - width: 640
          height: 480
        - width: 768
          height: 240
        - width: 800
          height: 600
      dynamicSizing: false
      types:
        - image/jpeg
        - image/jpg
        - image/png
        - image/apng
        - image/gif
        - image/heif
        - image/webp
        - audio/mpeg
        - audio/ogg
        - audio/wav
        - audio/flac
      allowAnimated: true
      defaultAnimated: false
      maxAnimateSizeBytes: 10485760
      stillFrame: 0.5
      expireAfterDays: 0
    rateLimit:
      enabled: true
      requestsPerSecond: 1
      burst: 10
    identicons:
      enabled: true
    quarantine:
      replaceThumbnails: true
      replaceDownloads: false
      allowLocalAdmins: true
    timeouts:
      urlPreviewTimeoutSeconds: 10
      federationTimeoutSeconds: 120
      clientServerTimeoutSeconds: 30
    metrics:
      enabled: false
      bindAddress: 127.0.0.1
      port: 9000
    featureSupport:
      MSC2448:
        enabled: false
        maxWidth: 1024
        maxHeight: 1024
        thumbWidth: 64
        thumbHeight: 64
        xComponents: 4
        yComponents: 3
        punch: 1
    redis:
      enabled: false
      databaseNumber: 0
      shards:
        - name: server1
          addr: ':7000'
        - name: server2
          addr: ':7001'
        - name: server3
          addr: ':7002'
    sentry:
      enabled: false
