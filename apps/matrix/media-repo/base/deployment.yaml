apiVersion: apps/v1
kind: Deployment
metadata:
  name: synapse-media
  labels:
    app: synapse-media
spec:
  selector:
    matchLabels:
      app: synapse-media
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: synapse-media
    spec:
      initContainers:
      - name: load-config
        image: docker.io/grubertech/envsubst:v1.2.0
        imagePullPolicy: IfNotPresent
        command: ["sh"]
        args:
        - -c
        - |
          envsubst -no-empty -i /template/config.yaml.tmpl -o /tmp/config.yaml \
          && cp -f /tmp/config.yaml /data/media-repo.yaml
        env:
          - name: POSTGRES_USER
            valueFrom: { secretKeyRef: { name: synapse.db-matrix.credentials.postgresql.acid.zalan.do, key: username } }
          - name: POSTGRES_PASSWORD
            valueFrom: { secretKeyRef: { name: synapse.db-matrix.credentials.postgresql.acid.zalan.do, key: password } }
          - name: SHARED_SECRET
            valueFrom: { secretKeyRef: { name: synapse-shared, key: SHARED_SECRET } }
        envFrom:
          - secretRef:
              name: matrix-media-vars
        volumeMounts:
        - name: config
          mountPath: /data
        - name: temp-dir
          mountPath: /tmp
        - name: template
          mountPath: /template/config.yaml.tmpl
          subPath: config.yaml.tmpl
          readOnly: true
        resources:
          limits:
            cpu: 400m
            memory: 512Mi
          requests:
            cpu: 300m
            memory: 256Mi
      containers:
      - name: media
        image: docker.io/turt2live/matrix-media-repo:v1.2.13
        imagePullPolicy: IfNotPresent
        ports:
        - name: web
          containerPort: 8000
          protocol: TCP
        volumeMounts:
        - name: config
          mountPath: /data
        resources:
          limits:
            cpu: 400m
            memory: 722Mi
          requests:
            cpu: 300m
            memory: 256Mi
      volumes:
      - name: template
        secret:
          secretName: matrix-media-config
      - name: temp-dir
        emptyDir: {}
      - name: config
        persistentVolumeClaim:
          claimName: synapse-media
