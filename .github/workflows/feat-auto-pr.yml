name: Open a PR when pushing to new application branch

on:
  push:
    branches-ignore:
    - main

jobs:
  auto-pull-request:
    name: PullRequestAction
    runs-on: ubuntu-latest
    steps:
      - name: Generate branch name
        uses: actions/github-script@v6
        id: set-branch-name
        with:
          script: |
            const capitalize = (name) => name.charAt(0).toUpperCase() + name.slice(1);
            const category = context.payload.ref.startsWith("refs/heads/feat")
              ? "[New App]"
              : context.payload.ref.startsWith("refs/heads/app")
              ? "`[New App]`"
              : "";
            return `${category} ${capitalize(
              context.payload.ref
                .replace("refs/heads/", "")
                .replace(/-/g, " ")
                .replace("feat/", "")
                .replace("app/", "")
            )}`;
          result-encoding: string
      - name: Set branch name
        run: echo "PULL_REQUEST_TITLE=${{steps.set-branch-name.outputs.result}}" >> $GITHUB_ENV
      - name: pull-request-action;'p'
        uses: vsoch/pull-request-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_PREFIX: "feat/"
          PULL_REQUEST_BRANCH: "main"
      - name: Generate PR body
        uses: actions/github-script@v6
        id: set-pr-body
        with:
          script: |
            return `Author: @${context.payload.head_commit.author.username
            } with ${context.payload.commits.length} commit${
              context.payload.commits.length === 1 ? "" : "s"
            }.`;
          result-encoding: string
      - name: Set PR body
        run: echo "PULL_REQUEST_BODY=${{steps.set-pr-body.outputs.result}}" >> $GITHUB_ENV
      - name: pull-request-action
        uses: vsoch/pull-request-action@d703f40f3af5ae294f9816395ddf2e3d2d3feafa # 1.0.21
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_PREFIX: feat
          PULL_REQUEST_BRANCH: main
          PULL_REQUEST_REVIEWERS: gruberdev
