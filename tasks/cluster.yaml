version: '3'
vars:
  CYAN: tput setaf 6
  RED: tput setaf 1
  YELLOW: tput setaf 3
  GREEN: tput setaf 2
  BLUE: tput setaf 1
  PURPLE: tput setaf 5
  BG_B: tput setab 0
  BOLD: tput bold
  RESET: tput sgr0
  CLEAR: tput reset
  PATH_ERROR: is not installed or correctly configured in PATH.
  SVC_CIDR: 10.43.0.0/16
  POD_CIDR: 10.42.0.0/16
  CLUSTER_DNS: 10.43.0.10
  CLUSTER_DOMAIN: cluster.local
  HA_DB_NAME: k3s
  KUBECONFIG_MODE: 0777
  DISABLE_K3S: traefik,localstorage
  RESOLV_FILE: /etc/resolv.conf
  FLANNEL_INTERFACE: tailscale0
silent: true

tasks:
  server:
    cmds:
      - |
        sudo curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server" sh -s - -c config/k3s/node-one.yaml
    ignore_error: true

  agent:
    cmds:
      - |
        sudo curl -sfL https://get.k3s.io | sh -s - agent \
        --token "${K3S_NODE_TOKEN}" \
        --server ${NODE_SERVER_IP} \
        --resolv-conf "{{.RESOLV_FILE}}"
    ignore_error: true

  dns:update:
    cmds:
      - |
        kubectl get cm -n kube-system kubelet-config -o=json | \
        jq 'del(.metadata.resourceVersion,.metadata.uid,.metadata.selfLink,.metadata.creationTimestamp,.metadata.annotations,.metadata.generation,.metadata.ownerReferences,.status)' | \
        sed -E 's#resolvConf: [^\n ]*\\n#resolvConf: /etc/kubeadm-resolv.conf\\n#' | \
        kubectl replace -f -
    ignore_error: true

  dns:restart:
    cmds:
      - kubectl -n kube-system rollout restart daemonset/kube-proxy
      - kubectl get pod -n kube-system -l k8s-app=kube-dns --no-headers | awk '{print $1}' | xargs -I{} kubectl delete pod -n kube-system {}
      - kubectl wait deployment -n kube-system coredns --for condition=Available=True --timeout=90s
      - kubectl logs deployment/coredns -n kube-system -f
    ignore_error: true

  # Debian fix
  # https://docs.k3s.io/advanced#additional-os-preparations
  fwd:fix:
    cmds:
      - sudo iptables -F
      - sudo update-alternatives --set iptables /usr/sbin/iptables-legacy
      - sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
      - echo "Reboot your machine."
    ignore_error: true

  fwd:replace:
    cmds:
      - sudo apt remove iptables nftables -y
      - echo "Reboot your machine."
      - Add to your startup script or terminal "'export PATH='/var/lib/rancher/k3s/data/current/bin/:/var/lib/rancher/k3s/data/current/bin/aux:$PATH'"
    ignore_error: true

  gen:node:one:
    cmds:
      - rm config/k3s/node-one.yaml
      - |
        cat << EOF > config/k3s/node-one.yaml
        node-name: "node-one"
        k3s_control_node: true
        write-kubeconfig-mode: "{{.KUBECONFIG_MODE}}"
        flannel-iface: "{{.FLANNEL_INTERFACE}}"
        write-kubeconfig: "${KUBECONFIG_PATH}"
        token: "${K3S_NODE_TOKEN}"
        cluster-cidr: "{{.POD_CIDR}}"
        service-cidr: "{{.SVC_CIDR}}"
        cluster-dns: "{{.CLUSTER_DNS}}"
        cluster-domain: "{{.CLUSTER_DOMAIN}}"
        node-ip: "${NODE_SERVER_IP}"
        external-node-ip: "${NODE_SERVER_IP}"
        server: "https://${TAILSCALE_IPV4}:6443"
        disable-network-policy: true
        resolv-conf: "{{.RESOLV_FILE}}"
        etcd-expose-metrics: true
        datastore-endpoint: "postgres://${HA_DB_USER}:${HA_DB_PASSWORD}@${BASTION_IPV4}/{{.HA_DB_NAME}}?sslmode=disable"
        kubelet-arg:
          - "feature-gates=GracefulNodeShutdown=true"
          - "feature-gates=MixedProtocolLBService=true"
        kube-controller-manager-arg:
          # Required to monitor component with kube-prometheus-stack
          - "bind-address=0.0.0.0"
          - "node-monitor-period=4s"
          - "node-monitor-grace-period=16s"
          - "pod-eviction-timeout=20s"
        kube-proxy-arg:
          - "metrics-bind-address=0.0.0.0"
        kube-scheduler-arg:
          - "bind-address=0.0.0.0"
        kube-apiserver-arg:
          - "default-not-ready-toleration-seconds=20"
          - "default-unreachable-toleration-seconds=20"
          - "feature-gates=MixedProtocolLBService=true"
          - "anonymous-auth=true"
        disable:
          - traefik
          - local-storage
          - metrics-server
        EOF
    ignore_error: true

  gen:node:two:
    cmds:
      - rm config/k3s/node-two.yaml
      - |
        cat << EOF > config/k3s/node-two.yaml
        node-name: "node-two"
        tls-san:
          - "${NODE_ONE_IP}"
          - "${NODE_TWO_IP}"
        write-kubeconfig-mode: "{{.KUBECONFIG_MODE}}"
        write-kubeconfig: "${KUBECONFIG_PATH}"
        token: "${K3S_NODE_TOKEN}"
        node-ip: "${NODE_SERVER_IP}"
        external-node-ip: "${NODE_SERVER_IP}"
        server: "https://"${NODE_SERVER_IP}":6443"
        etcd-expose-metrics: true
        cluster-init: true
        datastore-endpoint: "https://${NODE_SERVER_IP}:2379"
        datastore-cafile: "/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt"
        datastore-certfile: "/var/lib/rancher/k3s/server/tls/etcd/client.crt"
        datastore-keyfile: "/var/lib/rancher/k3s/server/tls/etcd/client.key"
        kubelet-arg:
          - "feature-gates=GracefulNodeShutdown=true"
            - "node-status-update-frequency=4s"
        kube-controller-manager-arg:
          - "bind-address=0.0.0.0"
          - "node-monitor-period=4s"
          - "node-monitor-grace-period=16s"
          - "pod-eviction-timeout=20s"
        kube-proxy-arg:
          - "metrics-bind-address=0.0.0.0"
        kube-scheduler-arg:
          - "bind-address=0.0.0.0"
        kube-apiserver-arg:
          - "default-not-ready-toleration-seconds=20"
          - "default-unreachable-toleration-seconds=20"
          - "anonymous-auth=true"
        disable:
          - traefik
          - local-storage
        EOF
    ignore_error: true

  gen:node:three:
    cmds:
      - rm config/k3s/node-two.yaml
      - |
        cat << EOF > config/k3s/node-three.yaml
        node-name: "node-three"
        server: "https://${CONTROLLER_IPV4}:6443"
        token: "${K3S_NODE_TOKEN}"
        node-ip: "${NODE_SERVER_IP}"
        kubelet-arg:
          - "feature-gates=GracefulNodeShutdown=true"
        kube-proxy-arg:
          - "metrics-bind-address=0.0.0.0"
        EOF
    ignore_error: true
